angular.module("afkl.lazyImage",[]),angular.module("afkl.lazyImage").service("afklSrcSetService",["$window",function(a){"use strict";function b(a){this.src=a.src,this.w=a.w||1/0,this.h=a.h||1/0,this.x=a.x||1}var c=/^[0-9]+$/,d=function(a){for(var b=a.split(/\s/),d={},e=0,f=b.length;f>e;e++){var g=b[e];if(g.length>0){var h=g.slice(-1),i=g.substring(0,g.length-1),j=parseInt(i,10),k=parseFloat(i);i.match(c)&&"w"===h?d[h]=j:i.match(c)&&"h"===h?d[h]=j:isNaN(k)||"x"!==h||(d[h]=k)}}return d},e=function(a,b){for(var c=a[0],d=0,e=a.length;e>d;d++){var f=a[d];b(f,c)&&(c=f)}return c},f=function(a,b){for(var c=a.length-1;c>=0;c--){var d=a[c];b(d)&&a.splice(c,1)}return a},g=function(b,c){if(b){c||(c={w:a.innerWidth||document.documentElement.clientWidth,h:a.innerHeight||document.documentElement.clientHeight,x:a.devicePixelRatio||1});var d=b.slice(0),g=e(d,function(a,b){return a.w>b.w});f(d,function(){return function(a){return a.w<c.w}}(this)),0===d.length&&(d=[g]);var h=e(d,function(a,b){return a.h>b.h});f(d,function(){return function(a){return a.h<c.h}}(this)),0===d.length&&(d=[h]);var i=e(d,function(a,b){return a.x>b.x});f(d,function(){return function(a){return a.x<c.x}}(this)),0===d.length&&(d=[i]);var j=e(d,function(a,b){return a.w<b.w});f(d,function(a){return a.w>j.w});var k=e(d,function(a,b){return a.h<b.h});f(d,function(a){return a.h>k.h});var l=e(d,function(a,b){return a.x<b.x});return f(d,function(a){return a.x>l.x}),d[0]}},h=function(a){var c=[],e=a.src,f=a.srcset;if(f){var h=function(a){for(var b=0,d=c.length;d>b;b++){var e=c[b];if(e.x===a.x&&e.w===a.w&&e.h===a.h)return}c.push(a)},i=function(){for(var a,c,g=f,i=0,j=[];""!==g;){for(;" "===g.charAt(0);)g=g.slice(1);i=g.indexOf(" "),-1!==i?(a=g.slice(0,i),g=g.slice(i+1),i=g.indexOf(","),-1===i?(c=g,g=""):(c=g.slice(0,i),g=g.slice(i+1)),j.push({url:a,descriptors:c})):(j.push({url:g,descriptors:""}),g="")}for(var k=0,l=j.length;l>k;k++){var m=j[k],n=d(m.descriptors);h(new b({src:m.url,x:n.x,w:n.w,h:n.h}))}e&&h(new b({src:e}))};i();var j=g(c),k={best:j,candidates:c};return c=null,k}};return{get:h,image:g}}]),angular.module("afkl.lazyImage").directive("afklImageContainer",function(){"use strict";return{restrict:"A",controller:["$scope","$element",function(a,b){b.data("afklImageContainer",b)}]}}).directive("afklLazyImage",["$rootScope","$window","$timeout","afklSrcSetService","$parse",function(a,b,c,d,e){"use strict";var f=function(a){var b,c=d.get({srcset:a});return c&&(b=c.best.src),b};return{restrict:"A",link:function(d,g,h){var i=function(a){var b=[];return o.imgAttrs&&(b=Array.prototype.map.call(a,function(a){for(var b in a)if(a.hasOwnProperty(b))return String.prototype.concat.call(b,'="',a[b],'"')})),b.join(" ")},j=g.inheritedData("afklImageContainer");j||(j=angular.element(h.afklLazyImageContainer||b));var k,l,m=!1,n=h.afklLazyImage,o=h.afklLazyImageOptions?e(h.afklLazyImageOptions)(d):{},p=null,q=o.offset?o.offset:50,r=o.alt?'alt="'+o.alt+'"':'alt=""',s=i(o.imgAttrs),t="afkl-lazy-image-loading",u="afkl-lazy-image";o.className&&(u=u+" "+o.className),h.afklLazyImageLoaded=!1;var v=function(){if(j.scrollTop){var a=j.scrollTop();if(a)return a}var b=j[0];return void 0!==b.pageYOffset?b.pageYOffset:void 0!==b.scrollTop?b.scrollTop:document.documentElement.scrollTop||0},w=function(){if(j.innerHeight)return j.innerHeight();var a=j[0];return void 0!==a.innerHeight?a.innerHeight:void 0!==a.clientHeight?a.clientHeight:document.documentElement.clientHeight||0},x=function(){if(g.offset)return g.offset().top;var a=g[0].getBoundingClientRect();return a.top+v()-document.documentElement.clientTop},y=function(){return g.offset?g.offset().top-j.offset().top:g[0].getBoundingClientRect().top-j[0].getBoundingClientRect().top},z=function(){o.background?g[0].style.backgroundImage='url("'+p+'")':l&&(l[0].src=p)},A=function(){m=!0;var a=f(n);a&&(o.background||l||(l=angular.element("<img "+r+" "+s+' class="'+u+'"/>'),g.append(l)),B()),j.off("scroll",E)},B=function(){if(m){var a=f(n);a!==p&&(p=a,!o.background&&l&&(g.addClass(t),l.one("load",C),l.one("error",D)),z())}};B();var C=function(){h.$set("afklLazyImageLoaded","done"),g.removeClass(t)},D=function(){h.$set("afklLazyImageLoaded","fail")},E=function(){if(!m){var a,c,d,e=w(),f=v(),g=j[0]===b?x():y();d=j[0]===b?e+f:e,a=g-d,c=q>=a,c&&A()}},F=function(){c.cancel(k),k=c(function(){B(),E()},300)},G=function(){c.cancel(k),j.off("scroll",E),angular.element(b).off("resize",F),j[0]!==b&&j.off("resize",F),l&&l.remove(),l=k=p=void 0};return j.on("scroll",E),angular.element(b).on("resize",F),j[0]!==b&&j.on("resize",F),h.$observe("afklLazyImage",function(){n=h.afklLazyImage,m&&A()}),o.nolazy&&A(),d.$on("afkl.lazyImage.destroyed",F),d.$on("$destroy",function(){return a.$broadcast("afkl.lazyImage.destroyed"),G()}),E()}}}]);